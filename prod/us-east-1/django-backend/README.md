# Django Backend Production Configuration

This directory contains the production Django backend infrastructure configuration.

## Stack Components

1. **PostgreSQL RDS** - Multi-AZ database with backups
2. **Redis ElastiCache** - Multi-AZ cache and Celery broker
3. **Django ECS Fargate** - Auto-scaling Django API service
4. **Cloudflare DNS** - DDoS protection and SSL termination

## Prerequisites

### 1. VPC Infrastructure ⚠️ BLOCKING

Current VPC (`vpc-02f48c62006cacfae`) only has private subnets. Need to add:
- 2 public subnets in different AZs
- Internet Gateway
- Public route table

**Options:**
- A) Manually create in AWS console (fastest)
- B) Add via Terraform/Terragrunt (proper IaC)
- C) Use different VPC that has public subnets

### 2. GitHub Actions Secrets

Configure in repository settings:

```bash
AWS_ACCESS_KEY_ID=<your-key>
AWS_SECRET_ACCESS_KEY=<your-secret>
```

### 3. Environment Variables (Set in GitHub workflow or locally)

```bash
# Required
export VPC_ID="vpc-02f48c62006cacfae"
export PRIVATE_SUBNET_IDS="subnet-00e39a8d07f4c256b,subnet-0ba0de978370667c6"
export PUBLIC_SUBNET_IDS="subnet-xxx,subnet-yyy"  # NEED TO CREATE
export ECR_REPOSITORY_URL="738605694078.dkr.ecr.us-east-1.amazonaws.com/lightwave-django-backend"
export IMAGE_TAG="prod"
export DJANGO_SECRET_KEY_ARN="<arn-from-secrets-manager>"
export DJANGO_ALLOWED_HOSTS="*.lightwave-media.ltd,*.amazonaws.com"
export DB_MASTER_USERNAME="postgres"
export DB_MASTER_PASSWORD="<secure-password>"
export CLOUDFLARE_API_TOKEN="<your-token>"
export CLOUDFLARE_ZONE_ID="<zone-id>"
export ALB_DNS_NAME="<auto-generated-by-django-service>"
```

### 4. AWS Secrets Manager

Create production secrets:

```bash
# Django SECRET_KEY
aws secretsmanager create-secret \
  --name /lightwave/prod/django/secret-key \
  --secret-string "$(python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')"

# Get ARN for DJANGO_SECRET_KEY_ARN
aws secretsmanager describe-secret \
  --secret-id /lightwave/prod/django/secret-key \
  --query ARN --output text
```

## Deployment via GitOps

### Step 1: Address VPC Public Subnets

Choose one option and complete before deployment.

### Step 2: Configure Secrets

Set GitHub secrets and create AWS secrets.

### Step 3: Push Configuration

```bash
git add .
git commit -m "feat: add Django production infrastructure configuration"
git push origin feature/prod-django-backend
```

### Step 4: Create PR and Merge

Merge to main branch (does NOT auto-deploy to prod).

### Step 5: Trigger Deployment

Via GitHub UI:
1. Go to Actions → "Deploy to Production"
2. Click "Run workflow"
3. Select `action: plan`
4. Review plan output
5. Run workflow again with `action: apply`
6. Approve deployment

## Post-Deployment

### Database Migrations

```bash
# Get ECS task ARN
TASK_ARN=$(aws ecs list-tasks --cluster lightwave-django-prod --query 'taskArns[0]' --output text)

# Run migrations
aws ecs execute-command \
  --cluster lightwave-django-prod \
  --task $TASK_ARN \
  --container django \
  --interactive \
  --command "python manage.py migrate"
```

### Create Superuser

```bash
aws ecs execute-command \
  --cluster lightwave-django-prod \
  --task $TASK_ARN \
  --container django \
  --interactive \
  --command "python manage.py createsuperuser"
```

### Verify Deployment

```bash
curl https://api.lightwave-media.ltd/health/live/
curl https://api.lightwave-media.ltd/health/ready/
```

## Cost Estimate

Monthly production costs:
- PostgreSQL RDS (db.t4g.small, Multi-AZ): ~$28
- Redis ElastiCache (cache.t4g.small, 2 nodes): ~$24
- ECS Fargate (2 x 0.5 vCPU, 1 GB): ~$30
- Application Load Balancer: ~$18
- **Total: ~$100/month**

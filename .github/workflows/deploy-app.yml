name: Deploy Application

# =============================================================================
# Centralized Application Deployment Workflow
# =============================================================================
#
# This workflow handles deployments for all LightWave applications.
# It's triggered by repository_dispatch from app repos and invokes
# the ECS Deploy Runner to build and deploy the application.
#
# Flow:
# 1. App repo pushes to main ‚Üí triggers repository_dispatch
# 2. This workflow receives the dispatch
# 3. Invokes Lambda to start ECS Deploy Runner task
# 4. Streams logs from ECS task
# 5. Reports success/failure
# =============================================================================

on:
  repository_dispatch:
    types:
      - deploy-app
      - build-image

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (e.g., cineos)'
        required: true
        type: choice
        options:
          - cineos
          - photographos
          - createos
          - lightwave-backend
          - lightwave-media-site
      git_ref:
        description: 'Git ref to deploy (commit SHA or tag)'
        required: true
        default: 'main'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - prod
          - staging
          - dev
        default: 'prod'
      task_type:
        description: 'Task type'
        required: true
        type: choice
        options:
          - app_deployer
          - docker_builder
        default: 'app_deployer'

env:
  AWS_REGION: us-east-1
  DEPLOY_RUNNER_LAMBDA: lightwave-deploy-runner-global-invoker

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  deploy:
    name: Deploy ${{ github.event.client_payload.app_name || inputs.app_name }}
    runs-on: ubuntu-latest

    steps:
      - name: Parse deployment parameters
        id: params
        run: |
          # Handle both repository_dispatch and workflow_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "app_name=${{ github.event.client_payload.app_name }}" >> $GITHUB_OUTPUT
            echo "git_ref=${{ github.event.client_payload.git_ref }}" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.client_payload.environment || 'prod' }}" >> $GITHUB_OUTPUT
            echo "task_type=${{ github.event.client_payload.task_type || 'app_deployer' }}" >> $GITHUB_OUTPUT
            echo "ecr_repository=${{ github.event.client_payload.ecr_repository }}" >> $GITHUB_OUTPUT
            echo "ecs_cluster=${{ github.event.client_payload.ecs_cluster }}" >> $GITHUB_OUTPUT
            echo "ecs_service=${{ github.event.client_payload.ecs_service }}" >> $GITHUB_OUTPUT
          else
            echo "app_name=${{ inputs.app_name }}" >> $GITHUB_OUTPUT
            echo "git_ref=${{ inputs.git_ref }}" >> $GITHUB_OUTPUT
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "task_type=${{ inputs.task_type }}" >> $GITHUB_OUTPUT
          fi

      - name: Validate deployment
        run: |
          echo "üöÄ Deployment Request"
          echo "===================="
          echo "App:         ${{ steps.params.outputs.app_name }}"
          echo "Git Ref:     ${{ steps.params.outputs.git_ref }}"
          echo "Environment: ${{ steps.params.outputs.environment }}"
          echo "Task Type:   ${{ steps.params.outputs.task_type }}"
          echo ""

          # Validate required fields
          if [ -z "${{ steps.params.outputs.app_name }}" ]; then
            echo "‚ùå Error: app_name is required"
            exit 1
          fi

          if [ -z "${{ steps.params.outputs.git_ref }}" ]; then
            echo "‚ùå Error: git_ref is required"
            exit 1
          fi

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::738605694078:role/lightwave-deploy-runner-global-github-actions
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-deploy-${{ steps.params.outputs.app_name }}

      - name: Invoke Deploy Runner Lambda
        id: invoke
        run: |
          echo "üì§ Invoking Deploy Runner Lambda..."

          # Build the payload
          PAYLOAD=$(cat <<EOF
          {
            "task_type": "${{ steps.params.outputs.task_type }}",
            "app_name": "${{ steps.params.outputs.app_name }}",
            "git_ref": "${{ steps.params.outputs.git_ref }}",
            "environment": "${{ steps.params.outputs.environment }}",
            "ecr_repository": "${{ steps.params.outputs.ecr_repository }}",
            "ecs_cluster": "${{ steps.params.outputs.ecs_cluster }}",
            "ecs_service": "${{ steps.params.outputs.ecs_service }}",
            "triggered_by": "github-actions"
          }
          EOF
          )

          echo "Payload: $PAYLOAD"

          # Invoke Lambda (raw-in-base64-out accepts raw JSON, don't pre-encode)
          RESPONSE=$(aws lambda invoke \
            --function-name ${{ env.DEPLOY_RUNNER_LAMBDA }} \
            --payload "$PAYLOAD" \
            --cli-binary-format raw-in-base64-out \
            /tmp/response.json)

          echo "Lambda response: $RESPONSE"
          cat /tmp/response.json

          # Parse response
          TASK_ARN=$(cat /tmp/response.json | jq -r '.body | fromjson | .task_arn // empty')
          TASK_ID=$(cat /tmp/response.json | jq -r '.body | fromjson | .task_id // empty')
          SUCCESS=$(cat /tmp/response.json | jq -r '.body | fromjson | .success // false')

          if [ "$SUCCESS" != "true" ]; then
            ERROR=$(cat /tmp/response.json | jq -r '.body | fromjson | .error // "Unknown error"')
            echo "‚ùå Lambda invocation failed: $ERROR"
            exit 1
          fi

          echo "‚úÖ ECS task started: $TASK_ID"
          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT

      - name: Wait for ECS task to complete
        id: wait
        run: |
          TASK_ARN="${{ steps.invoke.outputs.task_arn }}"
          CLUSTER_ARN="arn:aws:ecs:${{ env.AWS_REGION }}:738605694078:cluster/lightwave-deploy-runner-global"

          echo "‚è≥ Waiting for ECS task to complete..."
          echo "Task ARN: $TASK_ARN"

          # Poll task status
          MAX_WAIT=1800  # 30 minutes max
          POLL_INTERVAL=10
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws ecs describe-tasks \
              --cluster $CLUSTER_ARN \
              --tasks $TASK_ARN \
              --query 'tasks[0].lastStatus' \
              --output text)

            echo "Task status: $STATUS (${ELAPSED}s elapsed)"

            if [ "$STATUS" = "STOPPED" ]; then
              # Get exit code
              EXIT_CODE=$(aws ecs describe-tasks \
                --cluster $CLUSTER_ARN \
                --tasks $TASK_ARN \
                --query 'tasks[0].containers[0].exitCode' \
                --output text)

              STOP_REASON=$(aws ecs describe-tasks \
                --cluster $CLUSTER_ARN \
                --tasks $TASK_ARN \
                --query 'tasks[0].stoppedReason' \
                --output text)

              echo "Task completed with exit code: $EXIT_CODE"
              echo "Stop reason: $STOP_REASON"

              if [ "$EXIT_CODE" = "0" ]; then
                echo "‚úÖ Deployment successful!"
                echo "success=true" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "‚ùå Deployment failed with exit code: $EXIT_CODE"
                echo "success=false" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi

            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          echo "‚ùå Timeout waiting for task to complete"
          exit 1

      - name: Stream deployment logs
        if: always()
        run: |
          TASK_ID="${{ steps.invoke.outputs.task_id }}"
          LOG_GROUP="/ecs/lightwave-deploy-runner-global/app-deployer"

          echo "üìã Deployment Logs"
          echo "=================="

          # Get logs from CloudWatch
          aws logs filter-log-events \
            --log-group-name $LOG_GROUP \
            --log-stream-name-prefix "deployer/$TASK_ID" \
            --query 'events[*].message' \
            --output text 2>/dev/null || echo "No logs available yet"

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìä Deployment Summary"
          echo "====================="
          echo "App:         ${{ steps.params.outputs.app_name }}"
          echo "Git Ref:     ${{ steps.params.outputs.git_ref }}"
          echo "Environment: ${{ steps.params.outputs.environment }}"
          echo "Task ID:     ${{ steps.invoke.outputs.task_id }}"
          echo "Status:      ${{ steps.wait.outputs.success == 'true' && '‚úÖ Success' || '‚ùå Failed' }}"

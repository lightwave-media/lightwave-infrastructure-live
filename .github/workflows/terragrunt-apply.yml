name: Terragrunt Apply (Merge to Main)

# This workflow automatically applies infrastructure changes after merge to main.
# - Non-prod: Auto-applies after successful plan
# - Production: Requires manual approval via GitHub Environments

on:
  push:
    branches:
      - main
    paths:
      - 'non-prod/**'
      - 'prod/**'
      - 'root.hcl'
      - '*.hcl'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - non-prod
          - prod
      skip_plan:
        description: 'Skip plan step (not recommended)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for AWS OIDC
  actions: read

env:
  TG_BUCKET_PREFIX: lightwave-
  TERRAGRUNT_VERSION: 0.82.3
  OPENTOFU_VERSION: 1.9.0
  AWS_REGION: us-east-1

jobs:
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    outputs:
      non_prod_changed: ${{ steps.detect.outputs.non_prod_changed }}
      prod_changed: ${{ steps.detect.outputs.prod_changed }}
      should_deploy_non_prod: ${{ steps.detect.outputs.should_deploy_non_prod }}
      should_deploy_prod: ${{ steps.detect.outputs.should_deploy_prod }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Detect changed environments
        id: detect
        run: |
          # Manual workflow dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.environment }}" == "non-prod" ]]; then
              echo "non_prod_changed=true" >> $GITHUB_OUTPUT
              echo "prod_changed=false" >> $GITHUB_OUTPUT
              echo "should_deploy_non_prod=true" >> $GITHUB_OUTPUT
              echo "should_deploy_prod=false" >> $GITHUB_OUTPUT
            else
              echo "non_prod_changed=false" >> $GITHUB_OUTPUT
              echo "prod_changed=true" >> $GITHUB_OUTPUT
              echo "should_deploy_non_prod=false" >> $GITHUB_OUTPUT
              echo "should_deploy_prod=true" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Get list of changed files in the last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if non-prod changed
          if echo "$CHANGED_FILES" | grep -q "^non-prod/"; then
            echo "non_prod_changed=true" >> $GITHUB_OUTPUT
            echo "should_deploy_non_prod=true" >> $GITHUB_OUTPUT
            echo "âœ… Non-prod changes detected - will auto-deploy"
          else
            echo "non_prod_changed=false" >> $GITHUB_OUTPUT
            echo "should_deploy_non_prod=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No non-prod changes"
          fi

          # Check if prod changed
          if echo "$CHANGED_FILES" | grep -q "^prod/"; then
            echo "prod_changed=true" >> $GITHUB_OUTPUT
            echo "should_deploy_prod=true" >> $GITHUB_OUTPUT
            echo "âœ… Production changes detected - will require approval"
          else
            echo "prod_changed=false" >> $GITHUB_OUTPUT
            echo "should_deploy_prod=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No production changes"
          fi

  verify-remote-state-non-prod:
    name: Verify Remote State (Non-Prod)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_deploy_non_prod == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-VerifyStateNonProd

      - name: Verify remote state
        run: |
          chmod +x scripts/verify-remote-state.sh
          ./scripts/verify-remote-state.sh non-prod ${{ env.AWS_REGION }}

  plan-non-prod:
    name: Plan Non-Prod (Pre-Apply)
    runs-on: ubuntu-latest
    needs: [detect-changes, verify-remote-state-non-prod]
    if: |
      needs.detect-changes.outputs.should_deploy_non_prod == 'true' &&
      github.event.inputs.skip_plan != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-PlanNonProdApply

      - name: Terragrunt Plan
        working-directory: non-prod/us-east-1
        run: |
          terragrunt run-all plan \
            --terragrunt-non-interactive \
            --terragrunt-out-dir /tmp/plans
        env:
          TG_BUCKET_PREFIX: ${{ env.TG_BUCKET_PREFIX }}

  apply-non-prod:
    name: Apply Non-Prod Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, verify-remote-state-non-prod, plan-non-prod]
    if: |
      always() &&
      needs.detect-changes.outputs.should_deploy_non_prod == 'true' &&
      (needs.plan-non-prod.result == 'success' || github.event.inputs.skip_plan == 'true')
    environment:
      name: non-prod
      url: https://console.aws.amazon.com/
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ApplyNonProd

      - name: Terragrunt Apply
        id: apply
        working-directory: non-prod/us-east-1
        run: |
          set +e
          terragrunt run-all apply \
            --terragrunt-non-interactive \
            2>&1 | tee /tmp/apply-output.txt

          APPLY_EXIT_CODE=${PIPESTATUS[0]}

          echo "apply_output<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/apply-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $APPLY_EXIT_CODE
        env:
          TG_BUCKET_PREFIX: ${{ env.TG_BUCKET_PREFIX }}

      - name: Post-deployment smoke tests
        if: success()
        run: |
          if [[ -x scripts/smoke-test-nonprod.sh ]]; then
            echo "Running post-deployment smoke tests..."
            ./scripts/smoke-test-nonprod.sh
          else
            echo "âš ï¸  No smoke tests found, skipping..."
          fi

      - name: Post deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Non-Prod Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.apply.outcome }}" == "success" ]]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** Non-Prod" >> $GITHUB_STEP_SUMMARY
            echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check the logs above for error details.**" >> $GITHUB_STEP_SUMMARY
          fi

  verify-remote-state-prod:
    name: Verify Remote State (Production)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_deploy_prod == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-VerifyStateProd

      - name: Verify remote state
        run: |
          chmod +x scripts/verify-remote-state.sh
          ./scripts/verify-remote-state.sh prod ${{ env.AWS_REGION }}

  plan-prod:
    name: Plan Production (Pre-Apply)
    runs-on: ubuntu-latest
    needs: [detect-changes, verify-remote-state-prod]
    if: |
      needs.detect-changes.outputs.should_deploy_prod == 'true' &&
      github.event.inputs.skip_plan != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-PlanProdApply

      - name: Terragrunt Plan
        id: plan
        working-directory: prod/us-east-1
        run: |
          set +e
          terragrunt run-all plan \
            --terragrunt-non-interactive \
            --terragrunt-out-dir /tmp/plans \
            2>&1 | tee /tmp/plan-output.txt

          PLAN_EXIT_CODE=${PIPESTATUS[0]}

          echo "plan_output<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/plan-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $PLAN_EXIT_CODE
        env:
          TG_BUCKET_PREFIX: ${{ env.TG_BUCKET_PREFIX }}

      - name: Check for dangerous operations
        id: check_dangerous
        if: always()
        run: |
          if grep -q "will be destroyed\|must be replaced\|Plan: .* to destroy" /tmp/plan-output.txt; then
            echo "âš ï¸  CRITICAL: Detected resource destroys or replacements in production!"
            echo "has_dangerous_ops=true" >> $GITHUB_OUTPUT

            echo "dangerous_ops<<EOF" >> $GITHUB_OUTPUT
            grep -A 2 "will be destroyed\|must be replaced" /tmp/plan-output.txt >> $GITHUB_OUTPUT || true
            echo "EOF" >> $GITHUB_OUTPUT

            echo "## âš ï¸ CRITICAL WARNING âš ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This production deployment includes **DESTRUCTIVE OPERATIONS**:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -A 2 "will be destroyed\|must be replaced" /tmp/plan-output.txt >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Review this plan extremely carefully before approving the deployment!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No dangerous operations detected"
            echo "has_dangerous_ops=false" >> $GITHUB_OUTPUT
          fi

  apply-prod:
    name: Apply Production Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, verify-remote-state-prod, plan-prod]
    if: |
      always() &&
      needs.detect-changes.outputs.should_deploy_prod == 'true' &&
      (needs.plan-prod.result == 'success' || github.event.inputs.skip_plan == 'true')
    environment:
      name: production  # This triggers manual approval gate in GitHub
      url: https://console.aws.amazon.com/
    steps:
      - name: Pre-deployment announcement
        run: |
          echo "ðŸš¨ PRODUCTION DEPLOYMENT STARTING ðŸš¨"
          echo ""
          echo "Environment: Production"
          echo "Region: us-east-1"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: @${{ github.actor }}"
          echo ""
          echo "This deployment has been manually approved."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ApplyProd

      - name: Backup production state
        run: |
          if [[ -x scripts/backup-prod-state.sh ]]; then
            echo "Backing up production state..."
            ./scripts/backup-prod-state.sh
          else
            echo "âš ï¸  No backup script found, skipping state backup..."
          fi

      - name: Terragrunt Apply (Production)
        id: apply
        working-directory: prod/us-east-1
        run: |
          set +e
          terragrunt run-all apply \
            --terragrunt-non-interactive \
            2>&1 | tee /tmp/apply-output.txt

          APPLY_EXIT_CODE=${PIPESTATUS[0]}

          echo "apply_output<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/apply-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $APPLY_EXIT_CODE
        env:
          TG_BUCKET_PREFIX: ${{ env.TG_BUCKET_PREFIX }}

      - name: Post-deployment smoke tests
        if: success()
        run: |
          if [[ -x scripts/smoke-test-prod.sh ]]; then
            echo "Running production smoke tests..."
            ./scripts/smoke-test-prod.sh
          else
            echo "âš ï¸  No smoke tests found, skipping..."
          fi

      - name: Post deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.apply.outcome }}" == "success" ]]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** Production ðŸš¨" >> $GITHUB_STEP_SUMMARY
            echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "**Approved by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor CloudWatch dashboards" >> $GITHUB_STEP_SUMMARY
            echo "- Check application health endpoints" >> $GITHUB_STEP_SUMMARY
            echo "- Watch for errors in next 15 minutes" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PRODUCTION DEPLOYMENT FAILED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Immediate Actions Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review error logs above" >> $GITHUB_STEP_SUMMARY
            echo "2. Check AWS console for partial changes" >> $GITHUB_STEP_SUMMARY
            echo "3. Consider rollback if necessary" >> $GITHUB_STEP_SUMMARY
            echo "4. Notify infrastructure team" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Rollback instructions
        if: failure()
        run: |
          echo "## ðŸ”„ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If rollback is needed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd Infrastructure/lightwave-infrastructure-live/prod/us-east-1" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/backup-prod-state.sh --restore <backup-timestamp>" >> $GITHUB_STEP_SUMMARY
          echo "terragrunt run-all apply --terragrunt-non-interactive" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: [apply-non-prod, apply-prod]
    if: always()
    steps:
      - name: Generate notification summary
        run: |
          echo "## ðŸ“¢ Deployment Notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is where you would integrate with:" >> $GITHUB_STEP_SUMMARY
          echo "- Slack notifications (#infrastructure channel)" >> $GITHUB_STEP_SUMMARY
          echo "- PagerDuty alerts (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "- Email notifications to team" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Non-Prod Result: ${{ needs.apply-non-prod.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "Production Result: ${{ needs.apply-prod.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
